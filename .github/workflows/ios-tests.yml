name: iOS Unit Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: macOS-12  # macOS 12 (Monterey) 支持Xcode 13.3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode 13.3
      run: |
        # 列出所有可用Xcode版本并选择13.3
        sudo xcode-select -s /Applications/Xcode_13.3.app/Contents/Developer
        xcodebuild -version
      
    - name: Configure private specs repo access
      env:
        PRIVATE_SPECS_USERNAME: ${{ secrets.PRIVATE_SPECS_USERNAME }}
        PRIVATE_SPECS_TOKEN: ${{ secrets.PRIVATE_SPECS_TOKEN }}
      run: |
        git config --global credential.helper store
        echo "https://${PRIVATE_SPECS_USERNAME}:${PRIVATE_SPECS_TOKEN}@gitee.com" > ~/.git-credentials
      
    - name: Install CocoaPods 1.12.0
      run: |
        # 安装特定版本的CocoaPods
        gem install cocoapods -v 1.12.0
        pod --version  # 验证版本
        
    - name: Add private specs repo
      run: |
        pod repo add gitee-talon163-my-private-pod-specs https://gitee.com/talon163/my-private-pod-specs.git
        pod repo update
      
    - name: Install Dependencies
      run: |
        cd Example
        pod install
      
    # 确保iPhone 8 (iOS 15.4)模拟器存在并启动
    - name: Create and boot iPhone 8 simulator with iOS 15.4
      run: |
        # 检查是否已存在该模拟器
        SIMULATOR_ID=$(xcrun simctl list devices | grep "iPhone 8 (15.4)" | grep -Eo "[0-9A-F-]{36}")
        
        # 如果不存在则创建
        if [ -z "$SIMULATOR_ID" ]; then
          echo "Creating iPhone 8 (iOS 15.4) simulator..."
          SIMULATOR_ID=$(xcrun simctl create "iPhone 8 (15.4)" "iPhone 8" "iOS 15.4")
        fi
        
        # 启动模拟器
        xcrun simctl boot $SIMULATOR_ID
      
    - name: Run Unit Tests
      run: |
        cd Example
        
        SCHEME="RatingBox-Example"
        
        # 获取iPhone 8 (iOS 15.4)模拟器ID
        SIMULATOR_ID=$(xcrun simctl list devices | grep "iPhone 8 (15.4)" | grep -Eo "[0-9A-F-]{36}")
        
        echo "##[debug] Using iPhone 8 simulator (iOS 15.4) with ID: $SIMULATOR_ID"
        
        set -o pipefail
        xcodebuild test \
          -workspace RatingBox.xcworkspace \
          -scheme "$SCHEME" \
          -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
          ONLY_ACTIVE_ARCH=YES \
          CODE_SIGNING_ALLOWED=NO \
          | tee build.log
        
        if grep -q "TEST SUCCEEDED" build.log; then
          echo "✅ Tests passed"
        else
          echo "❌ Tests failed"
          cat build.log
          exit 1
        fi
        
    # 测试完成后关闭模拟器
    - name: Shutdown simulator
      if: always()
      run: |
        SIMULATOR_ID=$(xcrun simctl list devices | grep "iPhone 8 (15.4)" | grep -Eo "[0-9A-F-]{36}")
        if [ -n "$SIMULATOR_ID" ]; then
          xcrun simctl shutdown $SIMULATOR_ID
        fi
